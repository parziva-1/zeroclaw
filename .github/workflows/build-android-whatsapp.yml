name: Build Android Binary (with WhatsApp)

on:
  # Permite ejecutar el workflow manualmente desde la interfaz de GitHub
  workflow_dispatch:
    inputs:
      target:
        description: 'Arquitectura de Android (aarch64-linux-android / armv7-linux-androideabi)'
        required: true
        default: 'aarch64-linux-android'
        type: choice
        options:
          - aarch64-linux-android
          - armv7-linux-androideabi

env:
  CARGO_TERM_COLOR: always

jobs:
  build-android:
    name: Build for ${{ github.event.inputs.target || 'aarch64-linux-android' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0 # O la versión que uses
          targets: ${{ github.event.inputs.target || 'aarch64-linux-android' }}

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install Android NDK
        run: |
          # Descargar e instalar el NDK (ejemplo con la versión 26)
          wget -q https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip -q android-ndk-r26d-linux.zip
          echo "ANDROID_NDK_HOME=${PWD}/android-ndk-r26d" >> $GITHUB_ENV
          # Añadir el linker al PATH
          echo "${PWD}/android-ndk-r26d/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: Build binary (with WhatsApp feature)
        run: |
          cargo build --release --locked --verbose \
            --target ${{ github.event.inputs.target || 'aarch64-linux-android' }} \
            --features whatsapp-web

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: zeroclaw-${{ github.event.inputs.target || 'aarch64-linux-android' }}-with-whatsapp
          path: target/${{ github.event.inputs.target || 'aarch64-linux-android' }}/release/zeroclaw